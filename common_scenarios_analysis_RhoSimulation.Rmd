---
title: 'Comparing methods to assess correlation between time-series data with application to Bristol Bay, AK sockeye salmon escapement'
author:
  - K.F. Johnson^[School of Aquatic and Fishery Sciences, University of Washington, Box 355020, Seattle, WA 98195, USA]
  - I.C. Kaplan^[Conservation Biology Division, Northwest Fisheries Science Center, National Oceanic and Atmospheric Administration, 2725 Montlake Blvd. E., Seattle, WA 98112, USA]
  - A.E. Punt^[School of Aquatic and Fishery Sciences, University of Washington, Box 355020, Seattle, WA 98195, USA]
date: "`r format(Sys.time(), '%B %d, %Y')`"
abstract: |
  Abstract goes here.
keywords: correlation, simulation, time series
output:
  word_document:
    reference_docx: ms/common_scenarios_20170325_AEP.docx
bibliography: "c:/users/kelli/Google Drive/references/references.bib"
csl: "ecology.csl"
header-includes:
    - \usepackage{bm}
    - \usepackage{natbib}
---

```{r setup_input, echo = FALSE, results = "hide", warnings = FALSE, message = FALSE, include = FALSE}

#### Set up inputs
my.cor <- round(seq(-0.9, 0.9, by = 0.3), 3)
# \"zero\"
# \"unconstrained\"
# \"diagonal and equal\"
# \"diagonal and unequal\"
my.emQ <- "c(\"unconstrained\")"
my.emR <- "c(\"diagonal and equal\", \"zero\")"
my.iterations <- 100
my.length <- "c(10, 20, 100)"
my.name <- "RhoSimulation"
my.nparallel <- 4
my.sd <- c(0.01, 0.1, 1)

#### Setup knitr
knitr::opts_chunk$set(fig.width = 7, fig.height = 9.5,
  echo = FALSE, warning = FALSE, message = FALSE)

#### Setup libraries
repo <- "https://cloud.r-project.org"
library(doParallel, quietly = TRUE, verbose = FALSE)
library(foreach, quietly = TRUE, verbose = FALSE)
library(ggplot2, warn.conflicts = FALSE, quietly = TRUE, verbose = FALSE)
library(MARSS, warn.conflicts = FALSE, quietly = TRUE, verbose = FALSE)
library(pander, warn.conflicts = FALSE, quietly = TRUE, verbose = FALSE)

#### Setup plots
my.theme <- theme_bw() + theme(
  strip.background = element_blank(),
  panel.border = element_rect(colour = "white", fill = NA, size = 1),
  axis.text.x = element_text(angle = 45, hjust = 1),
  strip.text.y = element_text(angle = 45))

# Setup file structure
dir.main <- file.path(paste0(letters, ":"),
  file.path("atlantis", "common_scenarios_analysis"))
dir.main <- dir.main[file.exists(dir.main)]
if (length(dir.main) > 1) stop(length(dir.main),
  " atlantis/common_scenarios_analysis directories were found.")
dir.results <- file.path(dir.main, "results")
dir.create(dir.results, showWarnings = FALSE)
# Source the files to run the analysis
ignore <- sapply(
  dir(file.path(dir.main, "R"), full.names = TRUE, pattern = "\\.r|\\.R"),
  source)

#### Set up parallel
if (my.nparallel > 1) {
  cl <- makeCluster(my.nparallel)
  registerDoParallel(cl)
}
```

One cannot set an element of the diagonal of the $Q$ matrix to be zero
if the same element of the $B$ matrix is not also zero.
Therefore, no simulation will estimate just observation error, but
simulations can estimate just process error.
Furthermore, the "unconstrained" version of matrices for correlation
structures do not allow the mirror images of the off-diagonals to be
different.

```{r setup_simulation, echo = FALSE}
allspecs <- expand.grid(
  "B1" = my.cor, "B2" = my.cor,
  "Q1" = my.sd, "Q2" = my.cor,
  "Rom" = my.sd,
  "tslength" = my.length, "iterations" = my.iterations,
  "Qem" = my.emQ, "Rem" = my.emR,
  stringsAsFactors = FALSE)

temp <- apply(allspecs, 2, unique)
for (ii in seq_along(temp)) {
  if (grepl("c\\(", temp[ii][1])) temp[[ii]] <- eval(parse(text = temp[ii]))
}
allspecs_frame <- data.frame(matrix(NA,
  nrow = max(sapply(temp, length)), ncol = NROW(temp)))
for (ii in seq_along(temp)) {
  allspecs_frame[seq_along(temp[[ii]]), ii] <- temp[[ii]]
}
colnames(allspecs_frame) <- names(temp)

```

The simulation was ran with `r print(xtable(allspecs_frame))`

```{r run_simulation, echo = FALSE}
# test1 <- apply(allspecs[1029:1030, ], 1, run_simulation)
# test <- run_simulation(allspecs[1, ])
test <- foreach::foreach(
    it_ = seq_len(NROW(allspecs)),
    .packages = c("MARSS"),
    .verbose = TRUE,
    .export = ls()) %dopar%
    do.call("run_simulation",  list(specs = allspecs[it_, ], file = "specs"))
keep <- test
test <- data.frame(do.call("rbind", test))
test$EM_process <- gsub(" ", "~", test$EM_process)
test$EM_observation <- gsub(" ", "~", test$EM_observation)
test$process <- round(test$process, 3)
test$correlation <- round(test$correlation, 3)
```

```{r plot_exampletimeseries}
graycolours <- c("#bdbdbd", "#969696", "#636363")
plot_exampletimeseries(forvalues = c(min(my.cor), 0, max(my.cor)),
  plotcolours = graycolours,
  directory = dir.results)
```

```{r table_bestworst}
filename <- file.path(dir.results, "table_bestworst.tex")
printme <- rbind(data.frame("situation" = "best",
reshape(aggregate(est ~ par + process + correlation,
  data = droplevels(subset(test,
  grepl(":-1|:0|corr|[b-q]..2,1", par) &
  observation == min(my.sd) &
  autocorrelation %in% c(0) &
  n == 100 &
  correlation %in% c(0, range(my.cor)) &
  process %in% c(0, range(my.cor)) &
  EM_process %in% c("", "unconstrained"))),
  median),
  direction = "wide", timevar = "par",
  idvar = c("process", "correlation"))),
data.frame("situation" = "worst",
reshape(aggregate(est ~ par + process + correlation,
  data = droplevels(subset(test,
  grepl(":-1|:0|corr|[b-q]..2,1", par) &
  observation == max(my.sd) &
  autocorrelation == -0.9 &
  n == 10 &
  correlation %in% c(0, range(my.cor)) &
  process %in% c(0, range(my.cor)) &
  EM_process %in% c("", "unconstrained"))),
  median),
  direction = "wide", timevar = "par",
  idvar = c("process", "correlation"))))
colnames(printme) <- c(
  "situation",
  "process error", "interaction strength", "lag -1", "lag 0",
  "correlation", "$b_{2,1}$", "$q_{2,1}$")
printme <- printme[, c(1:3, 6, 4:5, 7:8)]
xtable::print.xtable(xtable::xtable(printme),
  include.rownames = FALSE,
  include.colnames = TRUE,
  sanitize.colnames.function = identity,
  hline.after = 9*1:2,
  file = filename)
system(paste("pandoc ", filename,
  "-o", gsub("tex", "doc", filename)))

```

```{r plot_all_noobservationerror}
#### Set up the plots
dataplot <- droplevels(subset(test,
    EM_observation %in% c("", "zero") &
    observation == min(my.sd) & process == 0 &
    # Remove b_{2,2} because it is very similar to b_{1,1}
    !grepl("b..2,2", par)))
dataplot$EM_process <- gsub("~", " ", dataplot$EM_process)
labels <- c("interaction strength (inner) x autocorrelation",
  "parameter estimates",
  "time-series\nlength")
colours <- c("#f1a340", "#f7f7f7", "#998ec3")
theme_local <- theme(
  axis.text.x = element_text(angle = 90, hjust = 1),
  strip.text.x = element_text(size = rel(1.5)),
  strip.text.y = element_text(size = rel(1.5)),
  legend.key = element_blank()
  )

#### Plot Pearson's correlation
for (ii in unique(test$n)) {
  temp <- subset(test,
    grepl("corr", par) &
    observation == min(my.sd) &
    # Subset for the number of years
    n == ii)
  temp <- aggregate(temp$est,
    list(temp$autocorrelation, temp$correlation, temp$process, temp$n),
    median)
  g <- ggplot(data =  temp,
    aes(x = factor(Group.2), y = factor(Group.3))) +
    geom_raster(aes(fill = x)) +
    facet_grid(Group.4 ~ Group.1) +
    scale_fill_gradient2(low = colours[1], midpoint = 0,
      mid = colours[2], high = colours[3],
      limits = c(-0.9, 0.9)) +
    my.theme + theme_local +
    theme(strip.text.y = element_text(size = rel(0))) +
    theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
    xlab("interaction (inner) x autocorrelation") +
    ylab("process error correlation") +
    labs(fill = "Pearson\ncorrelation") +
    geom_rect(aes(xmin = 3.5, xmax = 4.5, ymin = 0.5, ymax = 7.5),
      fill = NA, colour = "black", lty = 1, lwd = 1.5) +
    geom_rect(data = data.frame("Group.1" = 0, "Group.2" = my.cor, "Group.3" = my.cor), aes(xmin = 0.5, xmax = 7.45, ymin = 0.5, ymax = 7.5),
      fill = NA, colour = "black", lty = 2, lwd = 1.5)
    ggsave(
      filename = file.path(dir.results, paste0("correlation_", ii, ".png")),
      plot = g, height = 8, width = 15)
}

#### Plot CCF
for (ii in my.cor) {
g <- ggplot(data =
  droplevels(subset(test,
    grepl("ccf:-", par) &
    process == ii &
    observation == min(my.sd)
    )),
  aes(x = as.factor(correlation), y = est,
    # col = factor(n),
    fill = factor(n))) +
  geom_boxplot() +
  scale_colour_manual(values = graycolours) +
  scale_fill_manual(values = graycolours) +
  facet_grid(par ~ autocorrelation) +
  xlab(labels[1]) + ylab(labels[2]) +
  labs(fill = labels[3]) +
  ylim(c(-1.0, 1.0)) +
  my.theme + theme_local
  ggsave(
    filename = file.path(dir.results, paste0("ccf_process_", ii, ".png")),
    plot = g, height = 8, width = 11)
}

for (ii in my.cor) {
temp <- droplevels(subset(test,
    grepl("ccf:-|0", par) &
    n %in% range(eval(parse(text = my.length))) &
    autocorrelation == ii &
    observation == min(my.sd)
    ))
temp$par <- factor(temp$par, levels = c("ccf:0", "ccf:-1", "ccf:-2"))
g <- ggplot(data = temp,
  aes(x = as.factor(correlation), y = est,
    fill = factor(process))) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Greys") +
  facet_grid(par ~ n) +
  xlab("interaction strength") + ylab(labels[2]) +
  labs(fill = "process error\ncorrelation") +
  ylim(c(-1.0, 1.0)) +
  my.theme + theme_local
  ggsave(
    filename = file.path(dir.results, paste0("ccf_autocorrelation_", ii, ".png")),
    plot = g, height = 8, width = 11)
}

temp <- droplevels(subset(test,
  n %in% range(eval(parse(text = my.length))) &
  process == -0.9 &
  grepl(paste0("\\[.2"), par) &
  EM_process == "unconstrained"))
temp <- temp[c(
  which(temp$n == max(eval(parse(text = my.length))) &
  temp$observation == min(my.sd)),
  which(temp$n == min(eval(parse(text = my.length))) &
  temp$observation == max(my.sd))), ]

for (ii in c("b", "q")) {
  g <- ggplot(
  data = subset(temp, grepl(paste0(ii, "\\[.2"), par)),
  aes(x = as.factor(correlation),
    # col = factor(observation),
    fill = factor(n),
    y = est)) +
  geom_boxplot() +
  scale_fill_manual(values = tail(graycolours, 2),
    label = c("worst", "best")) +
  facet_grid(par ~ autocorrelation, label = label_parsed) +
  xlab(labels[1]) + ylab(labels[2]) +
  labs(fill = "Data\nscenario") +
  ylim(c(-1.5, 1.5)) +
  my.theme + theme_local
  ggsave(
    filename = file.path(dir.results, paste0("marss_qneg9_", ii, ".png")),
    plot = g, width = 15, height = 8)
}






for (ii_EM in unique(test$EM_process)) {
for (ii in levels(test$par)) {
  data <- test
  if (!grepl("b|q", ii)) {
    if (ii_EM != "") next
  }
  if (ii_EM == "") next
g <- ggplot(data = subset(data, par == ii & EM_process == ii_EM),
  aes(x = as.factor(autocorrelation), y = est, col = factor(n))) +
  geom_boxplot() +
  facet_grid(observation ~ correlation + process) +
  geom_hline(aes(yintercept = correlation), col = "red", lty = 2) +
  xlab("autocorrelation (inner) x correlation") +
  ylab("observation error level x time-series length") +
  ylim(c(-1.5, 1.5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle(paste(ii_EM, ii)) +
  my.theme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.key = element_blank()) +
  labs(col = "time-series\nlength")
ggsave(filename = file.path(dir.results, paste0(gsub(" ", "", ii_EM), "_par_", gsub(":", "-", ii), ".png")), g)
}}





```
